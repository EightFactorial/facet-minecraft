//! TODO

use core::fmt::Display;

use facet::Facet;
use facet_minecraft::{self as mc};

#[derive(Debug, Facet)]
struct Var<T>(#[facet(mc::variable)] pub T);

impl<T: Display> Display for Var<T> {
    fn fmt(&self, f: &mut core::fmt::Formatter<'_>) -> core::fmt::Result {
        Display::fmt(&self.0, f)
    }
}
impl<T: PartialEq> PartialEq for Var<T> {
    fn eq(&self, other: &Self) -> bool { self.0 == other.0 }
}

#[cfg(feature = "tracing")]
fn trace() -> tracing::subscriber::DefaultGuard {
    use tracing_subscriber::prelude::*;
    let subscriber =
        tracing_subscriber::registry().with(tracing_subscriber::fmt::layer().with_test_writer());
    tracing::subscriber::set_default(subscriber)
}

// -------------------------------------------------------------------------------------------------

macro_rules! test {
    ($ident:ident, $ty:ty: $($val:expr => $data:expr),*) => {
        #[test]
        fn $ident() {
            #[cfg(feature = "tracing")]
            let _guard = trace();

            $(
                let mut cursor = std::io::Cursor::new(Vec::new());
                facet_minecraft::to_writer::<$ty, _>(&$val, &mut cursor).unwrap();
                assert_eq!(cursor.get_ref(), $data, "From {} expected {:02x?}, got {:02x?}", $val, $data, cursor.get_ref());
            )*
        }

        #[cfg(feature = "futures-lite")]
        pastey::paste! {
            #[test]
            fn [<async_ $ident>]() {
                #[cfg(feature = "tracing")]
                let _guard = trace();

                $(
                    let mut cursor = futures_lite::io::Cursor::new(Vec::new());
                    futures_lite::future::block_on(facet_minecraft::to_async_writer::<$ty, _>(&$val, &mut cursor)).unwrap();
                    assert_eq!(cursor.get_ref(), $data, "From {} expected {:02x?}, got {:02x?}", $val, $data, cursor.get_ref());
                )*
            }
        }

        #[cfg(feature = "tokio")]
        pastey::paste! {
            #[tokio::test]
            async fn [<tokio_ $ident>]() {
                #[cfg(feature = "tracing")]
                let _guard = trace();

                $(
                    let mut cursor = std::io::Cursor::new(Vec::new());
                    facet_minecraft::to_tokio_writer::<$ty, _>(&$val, &mut cursor).await.unwrap();
                    assert_eq!(cursor.get_ref(), $data, "From {} expected {:02x?}, got {:02x?}", $val, $data, cursor.get_ref());
                )*
            }
        }
    };
}

test!(bool, bool: false => &[0x00], true => &[0x01]);
test!(u8, u8: 0 => &[0x00], 1 => &[0x01], 2 => &[0x02], 254 => &[0xfe], 255 => &[0xff]);
test!(i8, i8: -128 => &[0x80], -1 => &[0xff], 0 => &[0x00], 1 => &[0x01], 127 => &[0x7f]);
test!(u16, u16: 0 => &[0x00, 0x00], 1 => &[0x00, 0x01], 2 => &[0x00, 0x02], 65534 => &[0xff, 0xfe], 65535 => &[0xff, 0xff]);
test!(i16, i16: -32768 => &[0x80, 0x00], -1 => &[0xff, 0xff], 0 => &[0x00, 0x00], 1 => &[0x00, 0x01], 32767 => &[0x7f, 0xff]);
test!(u32, u32: 0 => &[0x00, 0x00, 0x00, 0x00], 1 => &[0x00, 0x00, 0x00, 0x01], 2 => &[0x00, 0x00, 0x00, 0x02], 4294967294u32 => &[0xff, 0xff, 0xff, 0xfe], 4294967295u32 => &[0xff, 0xff, 0xff, 0xff]);
test!(i32, i32: -2147483648i32 => &[0x80, 0x00, 0x00, 0x00], -1 => &[0xff, 0xff, 0xff, 0xff], 0 => &[0x00, 0x00, 0x00, 0x00], 1 => &[0x00, 0x00, 0x00, 0x01], 2147483647i32 => &[0x7f, 0xff, 0xff, 0xff]);
test!(u64, u64: 0 => &[0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00], 1 => &[0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01], 2 => &[0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x02], 18446744073709551614u64 => &[0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xfe], 18446744073709551615u64 => &[0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff]);
test!(i64, i64: -9223372036854775808i64 => &[0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00], -1 => &[0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff], 0 => &[0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00], 1 => &[0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01], 9223372036854775807i64 => &[0x7f, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff]);
test!(u128, u128: 0 => &[0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00], 1 => &[0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01], 2 => &[0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x02], 340282366920938463463374607431768211454u128 => &[0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xfe], 340282366920938463463374607431768211455u128 => &[0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff]);
test!(i128, i128: -170141183460469231731687303715884105728i128 => &[0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00], -1 => &[0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff], 0 => &[0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00], 1 => &[0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01], 170141183460469231731687303715884105727i128 => &[0x7f, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff]);

test!(var_u16, Var<u16>: Var(0) => &[0x00], Var(1) => &[0x01], Var(2) => &[0x02], Var(65534) => &[0xfe, 0xff, 0x03], Var(65535) => &[0xff, 0xff, 0x03]);
test!(var_i16, Var<i16>: Var(-32768) => &[0x80, 0x80, 0x02], Var(-1) => &[0xff, 0xff, 0x03], Var(0) => &[0x00], Var(1) => &[0x01], Var(32767) => &[0xff, 0xff, 0x01]);
test!(var_u32, Var<u32>: Var(0) => &[0x00], Var(1) => &[0x01], Var(2) => &[0x02], Var(4294967294u32) => &[0xfe, 0xff, 0xff, 0xff, 0x0f], Var(4294967295u32) => &[0xff, 0xff, 0xff, 0xff, 0x0f]);
test!(var_i32, Var<i32>: Var(-2147483648i32) => &[0x80, 0x80, 0x80, 0x80, 0x08], Var(-1) => &[0xff, 0xff, 0xff, 0xff, 0x0f], Var(0) => &[0x00], Var(1) => &[0x01], Var(2147483647i32) => &[0xff, 0xff, 0xff, 0xff, 0x07]);
test!(var_u64, Var<u64>: Var(0) => &[0x00], Var(1) => &[0x01], Var(2) => &[0x02], Var(18446744073709551614u64) => &[0xfe, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x01], Var(18446744073709551615u64) => &[0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x01]);
test!(var_i64, Var<i64>: Var(-9223372036854775808i64) => &[0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x01], Var(-1) => &[0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x01], Var(0) => &[0x00], Var(1) => &[0x01], Var(9223372036854775807i64) => &[0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x7f]);
test!(var_u128, Var<u128>: Var(0) => &[0x00], Var(1) => &[0x01], Var(2) => &[0x02], Var(340282366920938463463374607431768211454u128) => &[0xfe, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x03], Var(340282366920938463463374607431768211455u128) => &[0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x03]);
test!(var_i128, Var<i128>: Var(-170141183460469231731687303715884105728i128) => &[0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x02], Var(-1) => &[0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x03], Var(0) => &[0x00], Var(1) => &[0x01], Var(170141183460469231731687303715884105727i128) => &[0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x01]);
